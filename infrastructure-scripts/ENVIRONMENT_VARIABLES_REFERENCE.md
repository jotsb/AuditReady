# Complete Environment Variables Reference

This document lists ALL environment variables used by the infrastructure, matched to the docker-compose.yml.

## ‚úÖ All Variables Configured

Every variable required by docker-compose.yml is now properly configured in the .env file.

---

## üîê Secrets (Generated by 03-generate-secrets.sh)

### Database
| Variable | Size | Purpose |
|----------|------|---------|
| `POSTGRES_PASSWORD` | 32 chars | PostgreSQL admin password |
| `POSTGRES_USER` | N/A | Default: "postgres" |
| `POSTGRES_DB` | N/A | Default: "postgres" |
| `POSTGRES_HOST` | N/A | Default: "db" (container name) |
| `POSTGRES_PORT` | N/A | Default: 5432 |

### JWT & Authentication
| Variable | Size | Purpose |
|----------|------|---------|
| `JWT_SECRET` | 64 hex (32 bytes) | HS256 signing key for JWT tokens |
| `ANON_KEY` | JWT token | Public anonymous access token |
| `SERVICE_ROLE_KEY` | JWT token | Service role access token (full permissions) |

**IMPORTANT**: `ANON_KEY` and `SERVICE_ROLE_KEY` start as demo placeholders. Real tokens are generated by Kong on first startup! See "JWT Token Generation" section below.

### Encryption Keys
| Variable | Size | Purpose |
|----------|------|---------|
| `VAULT_ENC_KEY` | 64 hex (32 bytes) | AES-256 encryption for Supavisor connection strings |
| `SECRET_KEY_BASE` | 64 chars | Phoenix framework secret (Supavisor web interface) |
| `PG_META_CRYPTO_KEY` | 32 chars | Metadata encryption key |

### Dashboard
| Variable | Size | Purpose |
|----------|------|---------|
| `DASHBOARD_USERNAME` | N/A | Default: "supabase" |
| `DASHBOARD_PASSWORD` | 16 chars | Access to Supabase Studio |

---

## üîå Supavisor (Connection Pooler)

All variables from docker-compose.yml supavisor section:

| Variable | Value | Purpose |
|----------|-------|---------|
| `POOLER_TENANT_ID` | 32 hex chars | Unique tenant identifier |
| `REGION` | "local" | Region identifier for self-hosted |
| `ERL_AFLAGS` | "-proto_dist inet_tcp" | Erlang networking flags |
| `CLUSTER_POSTGRES` | "true" | Enable PostgreSQL clustering |
| `POOLER_DEFAULT_POOL_SIZE` | "15" | Default connection pool size per client |
| `POOLER_MAX_CLIENT_CONN` | "200" | Maximum simultaneous client connections |
| `POOLER_DB_POOL_SIZE` | "10" | Database connection pool size |
| `POOLER_PROXY_PORT_TRANSACTION` | "6543" | Port for transaction mode connections |

### Supavisor Configuration Notes

- **Transaction Mode** (port 6543): Connection held only during transaction
- **Session Mode** (port 5432): Connection held for entire session
- Pool sizes can be adjusted based on load:
  - Light load (<50 users): Current settings fine
  - Medium load (50-200 users): Increase `POOLER_DEFAULT_POOL_SIZE` to 20-30
  - Heavy load (>200 users): Increase `POOLER_MAX_CLIENT_CONN` to 500+

---

## üìä Vector Analytics

| Variable | Size | Purpose |
|----------|-------|---------|
| `LOGFLARE_PUBLIC_ACCESS_TOKEN` | 64 hex chars | Access token for Vector log analytics |

---

## üìß SMTP Configuration

| Variable | Default | Purpose |
|----------|---------|---------|
| `SMTP_ADMIN_EMAIL` | admin@test.auditproof.ca | Admin email address |
| `SMTP_HOST` | mail.smtp2go.com | SMTP server hostname |
| `SMTP_PORT` | 587 | SMTP server port (TLS) |
| `SMTP_USER` | (empty) | SMTP username - **CONFIGURE THIS** |
| `SMTP_PASS` | (empty) | SMTP password - **CONFIGURE THIS** |
| `SMTP_SENDER_NAME` | AuditProof | Display name for outgoing emails |
| `MAILER_AUTOCONFIRM` | false | Auto-confirm email addresses |

**To enable email**, add your SMTP credentials to secrets.txt and run `./04-configure-env.sh`.

---

## üåê URLs & External Access

| Variable | Value | Purpose |
|----------|-------|---------|
| `SITE_URL` | https://test.auditproof.ca | Public site URL |
| `API_EXTERNAL_URL` | https://test.auditproof.ca | External API endpoint |
| `SUPABASE_PUBLIC_URL` | https://test.auditproof.ca | Public Supabase URL |

---

## üîß Auth Configuration

| Variable | Value | Purpose |
|----------|-------|---------|
| `DISABLE_SIGNUP` | false | Allow new user registration |
| `ENABLE_EMAIL_SIGNUP` | true | Allow email/password signup |
| `ENABLE_EMAIL_AUTOCONFIRM` | false | Require email confirmation |
| `ENABLE_ANONYMOUS_USERS` | false | Disable anonymous auth |
| `MAILER_URLPATHS_CONFIRMATION` | /auth/v1/verify | Confirmation URL path |
| `MAILER_URLPATHS_INVITE` | /auth/v1/verify | Invitation URL path |
| `MAILER_URLPATHS_RECOVERY` | /auth/v1/verify | Recovery URL path |
| `MAILER_URLPATHS_EMAIL_CHANGE` | /auth/v1/verify | Email change URL path |

---

## üé® Studio Configuration

| Variable | Value | Purpose |
|----------|-------|---------|
| `STUDIO_DEFAULT_ORGANIZATION` | AuditProof | Default organization name |
| `STUDIO_DEFAULT_PROJECT` | Production | Default project name |

---

## üë§ Admin User (Created Automatically)

| Variable | Generated | Purpose |
|----------|-----------|---------|
| `ADMIN_EMAIL` | admin@test.auditproof.ca | Initial admin email |
| `ADMIN_PASSWORD` | 16 chars (random) | Initial admin password |

**Find credentials in**: `/mnt/user/appdata/auditproof/secrets.txt`

---

## ü§ñ OpenAI Integration

| Variable | Value | Purpose |
|----------|-------|---------|
| `OPENAI_API_KEY` | (your key) | OCR and AI features |

Used by edge function: `extract-receipt-data`

---

## üîë JWT Token Generation

### How JWT Tokens Work

1. **JWT_SECRET** is generated by the scripts (64 hex characters)
2. **Kong API Gateway** generates JWT tokens on first start using this secret
3. Two tokens are created:
   - `ANON_KEY` - Public access (limited permissions)
   - `SERVICE_ROLE_KEY` - Full access (admin operations)

### Initial Setup

Scripts include **demo placeholder tokens**:
```bash
ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"
SERVICE_ROLE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU"
```

These are **temporary demo tokens** from Supabase. They work but should be replaced.

### Getting Real Tokens

After running `./09-start-services.sh`:

```bash
# 1. Get tokens from Kong logs
docker logs supabase-kong 2>&1 | grep -E "(anon|service_role)"

# You'll see output like:
# anon: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJvbGUiOiJhbm9uIiwiZXhwIjoxOTgzODEyOTk2fQ.XXXXXXXXXXX
# service_role: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJvbGUiOiJzZXJ2aWNlX3JvbGUiLCJleHAiOjE5ODM4MTI5OTZ9.YYYYYYYYYYY

# 2. Update in Docker .env
vim /mnt/user/appdata/auditproof/supabase-project/.env
# Replace ANON_KEY and SERVICE_ROLE_KEY

# 3. Update in Frontend .env
vim /mnt/user/appdata/auditproof/project/AuditReady/.env
# Replace VITE_SUPABASE_ANON_KEY

# 4. Restart services
cd /mnt/user/appdata/auditproof/project/AuditReady/infrastructure-scripts
./09-start-services.sh
./10-start-frontend.sh
```

### Why Demo Tokens Work

The demo tokens are valid JWT tokens, but:
- They're publicly known (in Supabase docs)
- They expire in 2033 (far future)
- They work for development
- **Production should use real tokens**

Real tokens signed with your unique `JWT_SECRET` are more secure.

---

## üìù Complete .env File Structure

After running scripts, your `.env` will contain:

```env
# Secrets
POSTGRES_PASSWORD=<32 chars>
JWT_SECRET=<64 hex>
ANON_KEY=<jwt token - update after Kong starts>
SERVICE_ROLE_KEY=<jwt token - update after Kong starts>
VAULT_ENC_KEY=<64 hex>
SECRET_KEY_BASE=<64 chars>
DASHBOARD_PASSWORD=<16 chars>
PG_META_CRYPTO_KEY=<32 chars>
POOLER_TENANT_ID=<32 hex>

# Database
POSTGRES_HOST=db
POSTGRES_DB=postgres
POSTGRES_USER=postgres
POSTGRES_PORT=5432

# API
API_EXTERNAL_URL=https://test.auditproof.ca
SITE_URL=https://test.auditproof.ca

# Auth
DISABLE_SIGNUP=false
MAILER_URLPATHS_CONFIRMATION=/auth/v1/verify
MAILER_URLPATHS_INVITE=/auth/v1/verify
MAILER_URLPATHS_RECOVERY=/auth/v1/verify
MAILER_URLPATHS_EMAIL_CHANGE=/auth/v1/verify
ENABLE_EMAIL_SIGNUP=true
ENABLE_EMAIL_AUTOCONFIRM=false
ENABLE_ANONYMOUS_USERS=false

# Email (SMTP)
SMTP_ADMIN_EMAIL=admin@test.auditproof.ca
SMTP_HOST=mail.smtp2go.com
SMTP_PORT=587
SMTP_USER=
SMTP_PASS=
SMTP_SENDER_NAME=AuditProof
MAILER_AUTOCONFIRM=false

# Dashboard
DASHBOARD_USERNAME=supabase
DASHBOARD_PASSWORD=<16 chars>
STUDIO_DEFAULT_ORGANIZATION=AuditProof
STUDIO_DEFAULT_PROJECT=Production

# Supavisor (Connection Pooler)
REGION=local
ERL_AFLAGS=-proto_dist inet_tcp
CLUSTER_POSTGRES=true
POOLER_DEFAULT_POOL_SIZE=15
POOLER_MAX_CLIENT_CONN=200
POOLER_DB_POOL_SIZE=10
POOLER_PROXY_PORT_TRANSACTION=6543

# Vector Analytics
LOGFLARE_PUBLIC_ACCESS_TOKEN=<64 hex>
```

---

## üéØ Variable Checklist

Use this to verify all variables are configured:

### Core Secrets
- [ ] POSTGRES_PASSWORD
- [ ] JWT_SECRET
- [ ] ANON_KEY (demo initially, update after Kong starts)
- [ ] SERVICE_ROLE_KEY (demo initially, update after Kong starts)
- [ ] VAULT_ENC_KEY
- [ ] SECRET_KEY_BASE
- [ ] PG_META_CRYPTO_KEY
- [ ] DASHBOARD_PASSWORD

### Supavisor (7 variables)
- [ ] POOLER_TENANT_ID
- [ ] REGION
- [ ] ERL_AFLAGS
- [ ] CLUSTER_POSTGRES
- [ ] POOLER_DEFAULT_POOL_SIZE
- [ ] POOLER_MAX_CLIENT_CONN
- [ ] POOLER_DB_POOL_SIZE
- [ ] POOLER_PROXY_PORT_TRANSACTION

### Analytics
- [ ] LOGFLARE_PUBLIC_ACCESS_TOKEN

### SMTP (Optional)
- [ ] SMTP_ADMIN_EMAIL
- [ ] SMTP_HOST
- [ ] SMTP_PORT
- [ ] SMTP_USER (configure if needed)
- [ ] SMTP_PASS (configure if needed)
- [ ] SMTP_SENDER_NAME

### URLs
- [ ] SITE_URL
- [ ] API_EXTERNAL_URL
- [ ] SUPABASE_PUBLIC_URL

### OpenAI
- [ ] OPENAI_API_KEY

---

## üîç Verification

After setup, verify variables are loaded:

```bash
# Check Docker .env
cat /mnt/user/appdata/auditproof/supabase-project/.env | wc -l
# Should show ~40+ lines

# Verify Supavisor variables
grep POOLER /mnt/user/appdata/auditproof/supabase-project/.env
# Should show 4 POOLER_ variables

# Check JWT tokens
grep KEY /mnt/user/appdata/auditproof/supabase-project/.env
# Should show ANON_KEY and SERVICE_ROLE_KEY

# Verify Vector
grep LOGFLARE /mnt/user/appdata/auditproof/supabase-project/.env
```

---

## üìö Related Documentation

- Main setup: `README.md`
- Supavisor details: `SUPAVISOR_CONFIGURATION.md`
- Standalone scripts: `STANDALONE_EXECUTION.md`

---

**Generated by**: AuditProof Infrastructure Setup v2.0
**All variables**: ‚úÖ Configured
**Supavisor**: ‚úÖ Enabled with proper keys
**JWT Tokens**: Demo initially, Kong generates real ones
